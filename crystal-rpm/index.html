<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.36.1">
<meta name="crystal_docs.project_version" content="master">
<meta name="crystal_docs.project_name" content="rpm">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="rpm">
  <title>rpm master</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          rpm
        </a>
      </h1>

      <span class="project-version">
        master
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="rpm/RPM" data-name="rpm">
      <a href="RPM.html">RPM</a>
      
        <ul>
  
  <li class=" " data-id="rpm/RPM/AllocationError" data-name="rpm::allocationerror">
      <a href="RPM/AllocationError.html">AllocationError</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/BuildFlags" data-name="rpm::buildflags">
      <a href="RPM/BuildFlags.html">BuildFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/BuildPkgFlags" data-name="rpm::buildpkgflags">
      <a href="RPM/BuildPkgFlags.html">BuildPkgFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/CallbackType" data-name="rpm::callbacktype">
      <a href="RPM/CallbackType.html">CallbackType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/ChangeLog" data-name="rpm::changelog">
      <a href="RPM/ChangeLog.html">ChangeLog</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Conflict" data-name="rpm::conflict">
      <a href="RPM/Conflict.html">Conflict</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/DbiTag" data-name="rpm::dbitag">
      <a href="RPM/DbiTag.html">DbiTag</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/DbiTagValue" data-name="rpm::dbitagvalue">
      <a href="RPM/DbiTagValue.html">DbiTagValue</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Dependency" data-name="rpm::dependency">
      <a href="RPM/Dependency.html">Dependency</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/ElementType" data-name="rpm::elementtype">
      <a href="RPM/ElementType.html">ElementType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/ElementTypes" data-name="rpm::elementtypes">
      <a href="RPM/ElementTypes.html">ElementTypes</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/File" data-name="rpm::file">
      <a href="RPM/File.html">File</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/FileAttrs" data-name="rpm::fileattrs">
      <a href="RPM/FileAttrs.html">FileAttrs</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/FileDescriptor" data-name="rpm::filedescriptor">
      <a href="RPM/FileDescriptor.html">FileDescriptor</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/FileState" data-name="rpm::filestate">
      <a href="RPM/FileState.html">FileState</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/HeaderGetFlags" data-name="rpm::headergetflags">
      <a href="RPM/HeaderGetFlags.html">HeaderGetFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/HeaderPutFlags" data-name="rpm::headerputflags">
      <a href="RPM/HeaderPutFlags.html">HeaderPutFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Icon" data-name="rpm::icon">
      <a href="RPM/Icon.html">Icon</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/MatchIterator" data-name="rpm::matchiterator">
      <a href="RPM/MatchIterator.html">MatchIterator</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/MireMode" data-name="rpm::miremode">
      <a href="RPM/MireMode.html">MireMode</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Obsolete" data-name="rpm::obsolete">
      <a href="RPM/Obsolete.html">Obsolete</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Package" data-name="rpm::package">
      <a href="RPM/Package.html">Package</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/PackageError" data-name="rpm::packageerror">
      <a href="RPM/PackageError.html">PackageError</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Patch" data-name="rpm::patch">
      <a href="RPM/Patch.html">Patch</a>
      
    </li>
  
  <li class="parent " data-id="rpm/RPM/Problem" data-name="rpm::problem">
      <a href="RPM/Problem.html">Problem</a>
      
        <ul>
  
  <li class=" " data-id="rpm/RPM/Problem/BadArch" data-name="rpm::problem::badarch">
      <a href="RPM/Problem/BadArch.html">BadArch</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/BadOS" data-name="rpm::problem::bados">
      <a href="RPM/Problem/BadOS.html">BadOS</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/BadRelocate" data-name="rpm::problem::badrelocate">
      <a href="RPM/Problem/BadRelocate.html">BadRelocate</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/Conflicts" data-name="rpm::problem::conflicts">
      <a href="RPM/Problem/Conflicts.html">Conflicts</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/DiskNodes" data-name="rpm::problem::disknodes">
      <a href="RPM/Problem/DiskNodes.html">DiskNodes</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/DiskSpace" data-name="rpm::problem::diskspace">
      <a href="RPM/Problem/DiskSpace.html">DiskSpace</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/FileConflict" data-name="rpm::problem::fileconflict">
      <a href="RPM/Problem/FileConflict.html">FileConflict</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/NewFileConflict" data-name="rpm::problem::newfileconflict">
      <a href="RPM/Problem/NewFileConflict.html">NewFileConflict</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/Obsoletes" data-name="rpm::problem::obsoletes">
      <a href="RPM/Problem/Obsoletes.html">Obsoletes</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/OldPackage" data-name="rpm::problem::oldpackage">
      <a href="RPM/Problem/OldPackage.html">OldPackage</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/PackageInstalled" data-name="rpm::problem::packageinstalled">
      <a href="RPM/Problem/PackageInstalled.html">PackageInstalled</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/Requires" data-name="rpm::problem::requires">
      <a href="RPM/Problem/Requires.html">Requires</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Problem/Verify" data-name="rpm::problem::verify">
      <a href="RPM/Problem/Verify.html">Verify</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="rpm/RPM/ProblemSet" data-name="rpm::problemset">
      <a href="RPM/ProblemSet.html">ProblemSet</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/ProblemSetIterator" data-name="rpm::problemsetiterator">
      <a href="RPM/ProblemSetIterator.html">ProblemSetIterator</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/ProblemType" data-name="rpm::problemtype">
      <a href="RPM/ProblemType.html">ProblemType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Provide" data-name="rpm::provide">
      <a href="RPM/Provide.html">Provide</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Require" data-name="rpm::require">
      <a href="RPM/Require.html">Require</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Sense" data-name="rpm::sense">
      <a href="RPM/Sense.html">Sense</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Source" data-name="rpm::source">
      <a href="RPM/Source.html">Source</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/SourceBase" data-name="rpm::sourcebase">
      <a href="RPM/SourceBase.html">SourceBase</a>
      
    </li>
  
  <li class="parent " data-id="rpm/RPM/Spec" data-name="rpm::spec">
      <a href="RPM/Spec.html">Spec</a>
      
        <ul>
  
  <li class=" " data-id="rpm/RPM/Spec/PackageIterator" data-name="rpm::spec::packageiterator">
      <a href="RPM/Spec/PackageIterator.html">PackageIterator</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Spec/SourceIterator" data-name="rpm::spec::sourceiterator">
      <a href="RPM/Spec/SourceIterator.html">SourceIterator</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="rpm/RPM/Tag" data-name="rpm::tag">
      <a href="RPM/Tag.html">Tag</a>
      
    </li>
  
  <li class="parent " data-id="rpm/RPM/TagData" data-name="rpm::tagdata">
      <a href="RPM/TagData.html">TagData</a>
      
        <ul>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnType" data-name="rpm::tagdata::returntype(t)">
      <a href="RPM/TagData/ReturnType.html">ReturnType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeBase" data-name="rpm::tagdata::returntypebase">
      <a href="RPM/TagData/ReturnTypeBase.html">ReturnTypeBase</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeBin" data-name="rpm::tagdata::returntypebin">
      <a href="RPM/TagData/ReturnTypeBin.html">ReturnTypeBin</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeChar" data-name="rpm::tagdata::returntypechar">
      <a href="RPM/TagData/ReturnTypeChar.html">ReturnTypeChar</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeInt16" data-name="rpm::tagdata::returntypeint16">
      <a href="RPM/TagData/ReturnTypeInt16.html">ReturnTypeInt16</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeInt32" data-name="rpm::tagdata::returntypeint32">
      <a href="RPM/TagData/ReturnTypeInt32.html">ReturnTypeInt32</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeInt64" data-name="rpm::tagdata::returntypeint64">
      <a href="RPM/TagData/ReturnTypeInt64.html">ReturnTypeInt64</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeInt8" data-name="rpm::tagdata::returntypeint8">
      <a href="RPM/TagData/ReturnTypeInt8.html">ReturnTypeInt8</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeModule" data-name="rpm::tagdata::returntypemodule">
      <a href="RPM/TagData/ReturnTypeModule.html">ReturnTypeModule</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeString" data-name="rpm::tagdata::returntypestring">
      <a href="RPM/TagData/ReturnTypeString.html">ReturnTypeString</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagData/ReturnTypeUnion" data-name="rpm::tagdata::returntypeunion">
      <a href="RPM/TagData/ReturnTypeUnion.html">ReturnTypeUnion</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagDataFlags" data-name="rpm::tagdataflags">
      <a href="RPM/TagDataFlags.html">TagDataFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagDataFormat" data-name="rpm::tagdataformat">
      <a href="RPM/TagDataFormat.html">TagDataFormat</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagReturnType" data-name="rpm::tagreturntype">
      <a href="RPM/TagReturnType.html">TagReturnType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagType" data-name="rpm::tagtype">
      <a href="RPM/TagType.html">TagType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TagValue" data-name="rpm::tagvalue">
      <a href="RPM/TagValue.html">TagValue</a>
      
    </li>
  
  <li class="parent " data-id="rpm/RPM/Transaction" data-name="rpm::transaction">
      <a href="RPM/Transaction.html">Transaction</a>
      
        <ul>
  
  <li class=" " data-id="rpm/RPM/Transaction/Callback" data-name="rpm::transaction::callback">
      <a href="RPM/Transaction/Callback.html">Callback</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Transaction/CallbackBoxData" data-name="rpm::transaction::callbackboxdata">
      <a href="RPM/Transaction/CallbackBoxData.html">CallbackBoxData</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Transaction/CallbackReturnType" data-name="rpm::transaction::callbackreturntype">
      <a href="RPM/Transaction/CallbackReturnType.html">CallbackReturnType</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Transaction/Element" data-name="rpm::transaction::element">
      <a href="RPM/Transaction/Element.html">Element</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Transaction/Iterator" data-name="rpm::transaction::iterator">
      <a href="RPM/Transaction/Iterator.html">Iterator</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="rpm/RPM/TransactionError" data-name="rpm::transactionerror">
      <a href="RPM/TransactionError.html">TransactionError</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/TransactionFlags" data-name="rpm::transactionflags">
      <a href="RPM/TransactionFlags.html">TransactionFlags</a>
      
    </li>
  
  <li class=" " data-id="rpm/RPM/Version" data-name="rpm::version">
      <a href="RPM/Version.html">Version</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="crystal-rpm-crystal-cihttpsgithub.comlugia-kuncrystal-rpmworkflowscrystal20-cibadge.svghttpsgithub.comlugia-kuncrystal-rpmactionsqueryworkflow3-a22-crystalci22" class="anchor" href="#crystal-rpm-crystal-cihttpsgithub.comlugia-kuncrystal-rpmworkflowscrystal20-cibadge.svghttpsgithub.comlugia-kuncrystal-rpmactionsqueryworkflow3-a22-crystalci22">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>crystal-rpm <a href="https://github.com/lugia-kun/crystal-rpm/actions?query=workflow%3A%22Crystal+CI%22"><img src="https://github.com/lugia-kun/crystal-rpm/workflows/Crystal%20CI/badge.svg" alt="Crystal CI"/></a></h1>

<p>The <a href="http://rpm.org/">RPM</a> bindings for
<a href="https://crystal-lang.org/">Crystal</a> language based on
<a href="https://github.com/dmacvicar/ruby-rpm">ruby-rpm</a> and
<a href="https://github.com/dmacvicar/ruby-rpm-ffi">ruby-rpm-ffi</a>.</p>

<p>It supports RPM 4.8.0 or later.</p>

<h2><a id="before-use" class="anchor" href="#before-use">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Before use</h2>

<p>RPM is licensed under <a href="https://rpm.org/about.html">GNU GPL</a>. This
means all libraries and applications which link to RPM must be
licensed under GNU GPL. But, Crystal (and standard libraries) are
licensed under Apache-2.0, which will be incompatible.</p>

<p>Actual <code>COPYING</code> file in source tarball of RPM says that library part
of RPM (i.e., <code>librpm</code>) is licensed under LGPL 2.0 or later too, which
can be compatible with MIT and Apache-2.0.</p>

<p>So currently, crystal-rpm is licensed under both <a href="./COPYING">GPLv2 or
later</a> and <a href="./LICENSE">MIT</a> (which should be compatible
with LGPL 2.0 and Apache-2.0). We are thinking you do not have a
chance to use this library under the conditions of GPLv2, but left to
let us to keep in mind.</p>

<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<pre><code class="language-yaml">dependencies:
  rpm:
    github: lugia-kun/crystal-rpm</code></pre>

<ol><li>Run <code>shards install</code></li></ol>

<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;rpm&quot;</span></code></pre>

<p>The development files (pkg-config file) of <a href="https://rpm.org/">RPM</a> is
required. Typically, it can be installed by <code>yum install rpm-devel</code> on
CentOS or Red Hat, <code>dnf install rpm-devel</code> on Fedora, and <code>zypper in
rpm-devel</code> on openSUSE or SLES.</p>

<h3><a id="inspect-package" class="anchor" href="#inspect-package">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Inspect package</h3>

<pre><code class="language-crystal">pkg <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Package</span>.open(<span class="s">&quot;foobar-1.0-0.x86_64.rpm&quot;</span>)
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; &quot;foobar&quot;</span>
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Arch</span>] <span class="c"># =&gt; &quot;x86_64&quot;</span>
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Summary</span>] <span class="c"># =&gt; (Content of Summary)</span>
<span class="c"># and so on...</span>

pkg.requires <span class="c"># =&gt; Array of Requires.</span>
pkg.provides <span class="c"># =&gt; Array of Provides.</span>
pkg.conflicts <span class="c"># =&gt; Array of Conflicts.</span>
pkg.obsoletes <span class="c"># =&gt; Array of Obsolstes.</span></code></pre>

<h3><a id="install-package" class="anchor" href="#install-package">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Install package</h3>

<pre><code class="language-crystal"><span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  path <span class="o">=</span> <span class="s">&quot;pkg_to_install-1.0-0.x86_64.rpm&quot;</span>
  pkg <span class="o">=</span> ts.read_package_file(path)
  
  ts.install(pkg, path) <span class="c"># Add installation package. Package path is required.</span>
  ts.commit   <span class="c"># Run Transaction</span>
<span class="k">end</span></code></pre>

<p>BTW, <code>RPM::Package.open</code> allocates a <code>Transaction</code> inside. So if you
have an instance of <code>Transaction</code> already,
<code>Transaction#read_package_file</code> reduces allocations.</p>

<h3><a id="search-installed-packages" class="anchor" href="#search-installed-packages">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Search installed packages</h3>

<pre><code class="language-crystal"><span class="c"># with given name</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.db_iterator(<span class="t">RPM</span><span class="t">::</span><span class="t">DbiTag</span><span class="t">::</span><span class="t">Name</span>, <span class="s">&quot;package-name-to-find&quot;</span>) <span class="k">do</span> <span class="o">|</span>iter<span class="o">|</span>
    iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
      <span class="c"># Iterator over matching packages.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># with given regexp</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.db_iterator <span class="k">do</span> <span class="o">|</span>iter<span class="o">|</span>
    <span class="c"># Set condition</span>
    iter.regexp(<span class="t">RPM</span><span class="t">::</span><span class="t">DbiTag</span><span class="t">::</span><span class="t">Name</span>, <span class="c"># &lt;= Entry to search (here, Name)</span>
                <span class="t">RPM</span><span class="t">::</span><span class="t">MireMode</span><span class="t">::</span><span class="t">REGEX</span>, <span class="c"># &lt;= Default matching method</span>
                <span class="s">&quot;simple.*&quot;</span>) <span class="c">#  &lt;= Name to search</span>
    
    <span class="c"># Iterate over matching packages.</span>
    iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
      puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Version</span>].<span class="k">as</span>(<span class="t">String</span>) <span class="c"># =&gt; (Version of package &quot;simple&quot;)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># Iterate over all installed packages</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.db_iterator <span class="k">do</span> <span class="o">|</span>iter<span class="o">|</span>
    iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
      <span class="c"># ... iterates over all installed packages.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># Lookup package(s) which contains a specific file</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.db_iterator(<span class="t">RPM</span><span class="t">::</span><span class="t">DbiTag</span><span class="t">::</span><span class="t">BaseNames</span>, <span class="s">&quot;/path/to/lookup&quot;</span>) <span class="k">do</span> <span class="o">|</span>iter<span class="o">|</span>
    iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
      <span class="c"># ... iterates over packages contains &quot;/path/to/lookup&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># NOTE: Using regexp with BaseNames, it will search packages which</span>
<span class="c"># contain a file whose basename is the given name.</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.db_iterator <span class="k">do</span> <span class="o">|</span>iter<span class="o">|</span>
    iter.regexp(<span class="t">RPM</span><span class="t">::</span><span class="t">DbiTag</span><span class="t">::</span><span class="t">BaseNames</span>, <span class="t">RPM</span><span class="t">::</span><span class="t">MireMode</span><span class="t">::</span><span class="t">STRCMP</span>, <span class="s">&quot;README&quot;</span>)
    iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
      <span class="c"># ... iterates over packages which contain a file named &quot;README&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3><a id="remove-package" class="anchor" href="#remove-package">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Remove package</h3>

<pre><code class="language-crystal"><span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.delete(pkg) <span class="c"># Add to removal package</span>
  ts.order
  ts.clean
  ts.commit   <span class="c"># Run Transaction</span>
<span class="k">end</span></code></pre>

<h3><a id="using-transaction-without-block" class="anchor" href="#using-transaction-without-block">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Using Transaction without block</h3>

<p>For installing and/or removing packages, the DB handle is bound to the
transaction. So, DB must be closed via transaction.</p>

<pre><code class="language-crystal">ts <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Transaction</span>.<span class="k">new</span>
<span class="k">begin</span>
  ts.install(...)
  ts.delete(...)
  ts.order
  ts.clean
  ts.commit
<span class="k">ensure</span>
  ts.close_db <span class="c"># Must close DB</span>
<span class="k">end</span>
ts.finalize <span class="c"># Not nesseary, but recommended.</span></code></pre>

<h3><a id="using-db-iterator-without-block" class="anchor" href="#using-db-iterator-without-block">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Using DB iterator without block</h3>

<p>For searching packages in DB, the DB handle is bound to the
iterator. So, DB must be closed via finalizing the iterator.</p>

<pre><code class="language-crystal">ts <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Transaction</span>.<span class="k">new</span>
<span class="k">begin</span>
  iter <span class="o">=</span> ts.init_iterator(...)
  <span class="k">begin</span>
    iter.each <span class="k">do</span> <span class="o">|</span>item<span class="o">|</span>
      <span class="c"># work with item</span>
    <span class="k">end</span>
  <span class="k">ensure</span>
    iter.finalize <span class="c"># Must finalize iterator.</span>
  <span class="k">end</span>
<span class="k">end</span>
ts.finalize</code></pre>

<h3><a id="installremove-problems" class="anchor" href="#installremove-problems">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Install/Remove Problems</h3>

<pre><code class="language-crystal"><span class="t">RPM</span>.transation <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.install(...)
  ts.order
  ts.clean
  ts.check
  <span class="k">if</span> (problems <span class="o">=</span> ts.problems?)
    problems.each <span class="k">do</span> <span class="o">|</span>problem<span class="o">|</span>
      puts problem.to_s <span class="c"># =&gt; Output install (typically dependency) problems.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3><a id="inspect-specfile" class="anchor" href="#inspect-specfile">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Inspect Specfile</h3>

<pre><code class="language-crystal">spec <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Spec</span>.open(<span class="s">&quot;foo.spec&quot;</span>)
packages <span class="o">=</span> spec.packages
packages[<span class="n">0</span>][<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; (Name of the first package)</span>
packages[<span class="n">1</span>][<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; (Name of the second package)</span>
<span class="c"># NOTE: The order is undefined.</span>

spec.buildrequires <span class="c"># =&gt; Array of BuildRequires.</span></code></pre>

<h3><a id="build-rpm" class="anchor" href="#build-rpm">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Build RPM</h3>

<pre><code class="language-crystal"><span class="c"># Steps to be run.</span>
<span class="c">#</span>
<span class="c"># Here, %prep, %build, %install, %check, %clean and generates the source</span>
<span class="c"># and binary packages.</span>
<span class="c">#</span>
amount <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">BuildFlags</span>.flags(<span class="t">PREP</span>, <span class="t">BUILD</span>, <span class="t">INSTALL</span>, <span class="t">CHECK</span>, <span class="t">CLEAN</span>,
  <span class="t">PACKAGESOURCE</span>, <span class="t">PACKAGEBINARY</span>)

<span class="c"># Read specfile</span>
spec <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Spec</span>.open(<span class="s">&quot;foo.spec&quot;</span>)
spec.build(build_amount: amount)</code></pre>

<h2><a id="development" class="anchor" href="#development">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Development</h2>

<p>The definitions of structs are written by hand. Tests can check their
size and member offsets if you have a C compiler (optional).</p>

<p><a href="https://github.com/dex4er/fakechroot/wiki">fakechroot</a> (recommended),
<a href="https://proot-me.github.io/">proot</a> (untested), or root permission
(i.e., <code>sudo</code>) is required to run <code>crystal spec</code>, since this spec uses
<code>chroot()</code>.</p>

<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/lugia-kun/crystal-rpm/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>

<ul><li><a href="https://github.com/lugia-kun">Hajime Yoshimori</a> - creator and maintainer</li></ul>
</div>
</body>
</html>
