<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.27.1">


<link href="css/style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="js/doc.js"></script>
<script type="text/javascript">
  CrystalDoc.base_path = "";
</script>

  <meta id="repository-name" content="github.com/lugia-kun/crystal-rpm">
  <title>README - github.com/lugia-kun/crystal-rpm</title>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="repository-links">
      <a href="index.html">README</a>
    </div>
  </div>

  <div class="search-results" class="hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="github.com/lugia-kun/crystal-rpm/RPM" data-name="rpm">
      <a href="RPM.html">RPM</a>
      
        <ul>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/CallbackType" data-name="rpm::callbacktype">
      <a href="RPM/CallbackType.html">CallbackType</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/ChangeLog" data-name="rpm::changelog">
      <a href="RPM/ChangeLog.html">ChangeLog</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Conflict" data-name="rpm::conflict">
      <a href="RPM/Conflict.html">Conflict</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/DB" data-name="rpm::db">
      <a href="RPM/DB.html">DB</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/DbiTag" data-name="rpm::dbitag">
      <a href="RPM/DbiTag.html">DbiTag</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/DbiTagValue" data-name="rpm::dbitagvalue">
      <a href="RPM/DbiTagValue.html">DbiTagValue</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Dependency" data-name="rpm::dependency">
      <a href="RPM/Dependency.html">Dependency</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/File" data-name="rpm::file">
      <a href="RPM/File.html">File</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/FileAttrs" data-name="rpm::fileattrs">
      <a href="RPM/FileAttrs.html">FileAttrs</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/FileDescriptor" data-name="rpm::filedescriptor">
      <a href="RPM/FileDescriptor.html">FileDescriptor</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/FileState" data-name="rpm::filestate">
      <a href="RPM/FileState.html">FileState</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Icon" data-name="rpm::icon">
      <a href="RPM/Icon.html">Icon</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/MatchIterator" data-name="rpm::matchiterator">
      <a href="RPM/MatchIterator.html">MatchIterator</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/MireMode" data-name="rpm::miremode">
      <a href="RPM/MireMode.html">MireMode</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Obsolete" data-name="rpm::obsolete">
      <a href="RPM/Obsolete.html">Obsolete</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Package" data-name="rpm::package">
      <a href="RPM/Package.html">Package</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Patch" data-name="rpm::patch">
      <a href="RPM/Patch.html">Patch</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Problem" data-name="rpm::problem">
      <a href="RPM/Problem.html">Problem</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/ProblemSet" data-name="rpm::problemset">
      <a href="RPM/ProblemSet.html">ProblemSet</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/ProblemSetIterator" data-name="rpm::problemsetiterator">
      <a href="RPM/ProblemSetIterator.html">ProblemSetIterator</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/ProblemType" data-name="rpm::problemtype">
      <a href="RPM/ProblemType.html">ProblemType</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Provide" data-name="rpm::provide">
      <a href="RPM/Provide.html">Provide</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Require" data-name="rpm::require">
      <a href="RPM/Require.html">Require</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Sense" data-name="rpm::sense">
      <a href="RPM/Sense.html">Sense</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Source" data-name="rpm::source">
      <a href="RPM/Source.html">Source</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/SourceBase" data-name="rpm::sourcebase">
      <a href="RPM/SourceBase.html">SourceBase</a>
      
    </li>
  
  <li class="parent " data-id="github.com/lugia-kun/crystal-rpm/RPM/Spec" data-name="rpm::spec">
      <a href="RPM/Spec.html">Spec</a>
      
        <ul>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Spec/PackageIterator" data-name="rpm::spec::packageiterator">
      <a href="RPM/Spec/PackageIterator.html">PackageIterator</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Spec/SourceIterator" data-name="rpm::spec::sourceiterator">
      <a href="RPM/Spec/SourceIterator.html">SourceIterator</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Tag" data-name="rpm::tag">
      <a href="RPM/Tag.html">Tag</a>
      
    </li>
  
  <li class="parent " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagData" data-name="rpm::tagdata">
      <a href="RPM/TagData.html">TagData</a>
      
        <ul>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagData/ElementUnion" data-name="rpm::tagdata::elementunion">
      <a href="RPM/TagData/ElementUnion.html">ElementUnion</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagData/Iterator" data-name="rpm::tagdata::iterator(t)">
      <a href="RPM/TagData/Iterator.html">Iterator</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagReturnType" data-name="rpm::tagreturntype">
      <a href="RPM/TagReturnType.html">TagReturnType</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagType" data-name="rpm::tagtype">
      <a href="RPM/TagType.html">TagType</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TagValue" data-name="rpm::tagvalue">
      <a href="RPM/TagValue.html">TagValue</a>
      
    </li>
  
  <li class="parent " data-id="github.com/lugia-kun/crystal-rpm/RPM/Transaction" data-name="rpm::transaction">
      <a href="RPM/Transaction.html">Transaction</a>
      
        <ul>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Transaction/Callback" data-name="rpm::transaction::callback">
      <a href="RPM/Transaction/Callback.html">Callback</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Transaction/CallbackBoxData" data-name="rpm::transaction::callbackboxdata">
      <a href="RPM/Transaction/CallbackBoxData.html">CallbackBoxData</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Transaction/CallbackReturnType" data-name="rpm::transaction::callbackreturntype">
      <a href="RPM/Transaction/CallbackReturnType.html">CallbackReturnType</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/TransactionFlags" data-name="rpm::transactionflags">
      <a href="RPM/TransactionFlags.html">TransactionFlags</a>
      
    </li>
  
  <li class=" " data-id="github.com/lugia-kun/crystal-rpm/RPM/Version" data-name="rpm::version">
      <a href="RPM/Version.html">Version</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1>crystal-rpm</h1>

<p>The [RPM] bindings for [Crystal] language based on [ruby-rpm] and
[ruby-rpm-ffi].</p>

<p>It supports RPM 4.8.0 or later.</p>

<h2>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<pre><code class="language-yaml">dependencies:
  rpm:
    github: lugia-kun/crystal-rpm</code></pre>

<ol><li>Run <code>shards install</code></li></ol>

<h2>Usage</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;rpm&quot;</span></code></pre>

<p>The development files (pkg-config file) of [RPM] is
required. Typically, it can be installed by <code>yum install rpm-devel</code> on
CentOS or Red Hat, <code>dnf install rpm-devel</code> on Fedora, and <code>zypper in
rpm-devel</code> on openSUSE or SLES.</p>

<h3>Inspect package</h3>

<pre><code class="language-crystal">pkg <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Package</span>.open(<span class="s">&quot;foobar-1.0-0.x86_64.rpm&quot;</span>)
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; &quot;foobar&quot;</span>
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Arch</span>] <span class="c"># =&gt; &quot;x86_64&quot;</span>
puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Summary</span>] <span class="c"># =&gt; (Content of Summary)</span>
<span class="c"># and so on...</span>

pkg.requires <span class="c"># =&gt; Array of Requires.</span>
pkg.provides <span class="c"># =&gt; Array of Provides.</span>
pkg.conflicts <span class="c"># =&gt; Array of Conflicts.</span>
pkg.obsoletes <span class="c"># =&gt; Array of Obsolstes.</span></code></pre>

<h3>Install package</h3>

<pre><code class="language-crystal"><span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  path <span class="o">=</span> <span class="s">&quot;pkg_to_install-1.0-0.x86_64.rpm&quot;</span>
  pkg <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Package</span>.open(path)
  <span class="k">begin</span>
    ts.install(pkg, path) <span class="c"># Add installation package. Package path is required.</span>
    ts.commit   <span class="c"># Run Transaction</span>
  <span class="k">ensure</span>
    ts.db.close <span class="c"># must close Database.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3>Search installed packages</h3>

<pre><code class="language-crystal"><span class="c"># with given name</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  iter <span class="o">=</span> ts.init_iterator   <span class="c"># Create iterator of installed packages</span>
  
  <span class="c"># Set condition</span>
  iter.regexp(<span class="t">RPM</span><span class="t">::</span><span class="t">DbiTag</span><span class="t">::</span><span class="t">Name</span>, <span class="c"># &lt;= Entry to search (here, Name)</span>
              <span class="t">RPM</span><span class="t">::</span><span class="t">MireMode</span><span class="t">::</span><span class="t">DEFAULT</span>, <span class="c"># &lt;= Default matching method</span>
              <span class="s">&quot;simple&quot;</span>) <span class="c">#  &lt;= Name to search</span>

  <span class="c"># Iterate over matching packages.</span>
  iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
    puts pkg[<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Version</span>].<span class="k">as</span>(<span class="t">String</span>) <span class="c"># =&gt; (Version of package &quot;simple&quot;)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># Iterate over all installed packages</span>
<span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  iter <span class="o">=</span> ts.init_iterator
  iter.each <span class="k">do</span> <span class="o">|</span>pkg<span class="o">|</span>
    <span class="c"># ... iterates over all installed packages.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3>Remove package</h3>

<p>Currently, the following code does not work unless you are using
OpenSUSE (see #1).</p>

<pre><code class="language-crystal"><span class="t">RPM</span>.transaction <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  <span class="k">begin</span>
    ts.delete(pkg) <span class="c"># Add to removal package</span>
    ts.order
    ts.clean
    ts.commit   <span class="c"># Run Transaction</span>
  <span class="k">ensure</span>
    ts.db.close <span class="c"># must close Database.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3>Using Transaction without block</h3>

<pre><code class="language-crystal">ts <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Transaction</span>.<span class="k">new</span>
<span class="k">begin</span>
  ts.install(...)
  ts.delete(...)
  ts.order
  ts.clean
  ts.commit
<span class="k">ensure</span>
  ts.db.close
<span class="k">end</span>
ts.finalize <span class="c"># Not nesseary, but recommended.</span></code></pre>

<h3>Install/Remove Problems</h3>

<pre><code class="language-crystal"><span class="t">RPM</span>.transation <span class="k">do</span> <span class="o">|</span>ts<span class="o">|</span>
  ts.install(...)
  ts.order
  ts.clean
  problems <span class="o">=</span> ts.check
  problems.each <span class="k">do</span> <span class="o">|</span>problem<span class="o">|</span>
    puts problem.to_s <span class="c"># =&gt; Output install (typically dependency) problems.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3>Inspect Specfile</h3>

<pre><code class="language-crystal">spec <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Spec</span>.open(<span class="s">&quot;foo.spec&quot;</span>)
packages <span class="o">=</span> spec.packages
packages[<span class="n">0</span>][<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; (Name of the first package)</span>
packages[<span class="n">1</span>][<span class="t">RPM</span><span class="t">::</span><span class="t">Tag</span><span class="t">::</span><span class="t">Name</span>] <span class="c"># =&gt; (Name of the second package)</span>
<span class="c"># NOTE: The order is undefined.</span>

spec.buildrequires <span class="c"># =&gt; Array of BuildRequires.</span></code></pre>

<h3>Build RPM</h3>

<pre><code class="language-crystal">spec <span class="o">=</span> <span class="t">RPM</span><span class="t">::</span><span class="t">Spec</span>.open(<span class="s">&quot;foo.spec&quot;</span>)
spec.build</code></pre>

<h2>Development</h2>

<p>The definitiions of structs are written by hand. Tests can check their
size and member offsets if you have a C compiler (optional).</p>

<p>[fakechroot] (recommended) or root permission (i.e., <code>sudo</code>) is
required to run <code>crystal spec</code>, since this spec uses <code>chroot()</code>.</p>

<p>Alternatively, using Docker is another method to test:</p>

<pre><code class="language-bash">$ shards install
$ docker build -t [version] -f .travis/Dockerfile.rpm-[version] .
$ docker run -v $(pwd):/work -w /work [version] crystal spec</code></pre>

<p>Note that shards should be installed on local (because git in CentOS 6
is too old and does not work with shards).</p>

<h2>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/lugia-kun/crystal-rpm/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<h2>Contributors</h2>

<ul><li><a href="https://github.com/lugia-kun" target="_blank">Hajime Yoshimori</a> - creator and maintainer</li></ul>

<p>[RPM]: http://rpm.org/
[Crystal]: https://crystal-lang.org/
[ruby-rpm]: https://github.com/dmacvicar/ruby-rpm
[ruby-rpm-ffi]: https://github.com/dmacvicar/ruby-rpm-ffi
[fakechroot]: https://github.com/dex4er/fakechroot/wiki</p>
</div>
</body>
</html>
